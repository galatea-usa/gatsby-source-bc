{"version":3,"sources":["../src/utils/bigcommerce.js"],"names":["BigCommerce","config","errMessage","Error","grantType","createAPIRequest","endpoint","acceptHeader","responseType","Request","headers","Object","assign","clientId","accessToken","failOnLimitReached","agent","verify","signedRequest","console","error","FG_RED","splitRequest","split","length","signature","Buffer","from","toString","json","data","expected","crypto","createHmac","secret","update","digest","log","FG_BLUE","timingSafeEqual","FG_GREEN","authorize","query","code","scope","context","queryCode","queryScope","queryContext","payload","client_id","client_secret","grant_type","request","REQUEST_BIGCOMMERCE_LOGIN_URL","oauthToken","run","type","path","storeHash","extension","REQUEST_BIGCOMMERCE_API_URL","version","includes","replace","fullPath","response","meta","pagination","totalPages","total_pages","currentPage","current_page","promises","nextPage","endpointUrl","URL","hostname","searchParams","set","push","pathname","search","Promise","all","responses","forEach","pageResponse","concat","get","post","put","delete"],"mappings":"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","sourcesContent":["import crypto from \"crypto\";\nimport { FG_BLUE, FG_GREEN, FG_RED, REQUEST_BIGCOMMERCE_API_URL, REQUEST_BIGCOMMERCE_LOGIN_URL } from \"../constants\";\nimport { handleConversionStringToObject } from \"./convertValues\";\nimport Request from \"./request\";\n\nclass BigCommerce {\n\tconstructor(config) {\n\t\tif (!config) {\n\t\t\tconst errMessage = new Error(\"Config missing. The config object is required to make any call to the \" + \"BigCommerce API\");\n\n\t\t\tthrow errMessage;\n\t\t}\n\n\t\tthis.config = config;\n\t\tthis.grantType = \"authorization_code\";\n\t}\n\n\t// Handle creating API request\n\tcreateAPIRequest(endpoint) {\n\t\tconst acceptHeader = this.config.responseType === \"xml\" ? \"application/xml\" : \"application/json\";\n\n\t\treturn new Request(endpoint, {\n\t\t\theaders: Object.assign({\n\t\t\t\t\"Accept\": acceptHeader,\n\t\t\t\t\"X-Auth-Client\": this.config.clientId,\n\t\t\t\t\"X-Auth-Token\": this.config.accessToken\n\t\t\t}),\n\t\t\tfailOnLimitReached: this.config.failOnLimitReached,\n\t\t\tagent: this.config.agent\n\t\t});\n\t}\n\n\t// Handle verfiy signed request\n\tasync verify(signedRequest) {\n\t\t// If `signedRequest` is \"undefined\", throw an error\n\t\t!signedRequest ? console.error(FG_RED, \"The signed request is required to verify the call.\") : null;\n\n\t\tconst splitRequest = signedRequest.split(\".\");\n\n\t\t// If `splitRequest` length is less than 2, throw an error\n\t\tsplitRequest.length < 2 ? console.error(FG_RED, \"The signed request will come in two parts seperated by a .(full stop). \" + \"this signed request contains less than 2 parts.\") : null;\n\n\t\t// Check and verify validity of signatures\n\t\tconst signature = Buffer.from(splitRequest[1], \"base64\").toString(\"utf8\");\n\t\tconst json = Buffer.from(splitRequest[0], \"base64\").toString(\"utf8\");\n\t\tconst data = handleConversionStringToObject(json);\n\t\tconst expected = crypto.createHmac(\"sha256\", this.config.secret).update(json).digest(\"hex\");\n\n\t\tconsole.log(FG_BLUE, \"\\nJSON: \" + json);\n\t\tconsole.log(FG_BLUE, \"\\nSIGNATURE: \" + signature);\n\t\tconsole.log(FG_BLUE, \"\\nEXPECTED SIGNATURE: \" + expected);\n\n\t\t// If the expected length of signature doesn't match the current signature length, throw an error, otherwise return data\n\t\texpected.length !== signature.length || crypto.timingSafeEqual(Buffer.from(expected, \"utf8\"), Buffer.from(signature, \"utf8\")) ? console.error(FG_RED, \"The signature is invalid.\") : null;\n\n\t\t// Send log message when signature is valid\n\t\tconsole.log(FG_GREEN, \"The signature is valid.\");\n\n\t\treturn data;\n\t}\n\n\t// Handle authentication request\n\tasync authorize(query) {\n\t\t// if `query` is undefined, throw an error\n\t\t!query ? console.error(FG_RED, \"The URL query paramaters are required.\") : null;\n\n\t\t// Query props\n\t\tconst { code, scope, context } = await query;\n\t\tconst queryCode = code ?? null;\n\t\tconst queryScope = scope ?? null;\n\t\tconst queryContext = context ?? null;\n\n\t\t// Init payload\n\t\tconst payload = {\n\t\t\tclient_id: this.config.clientId,\n\t\t\tclient_secret: this.config.secret,\n\t\t\tgrant_type: this.grantType,\n\t\t\tcode: queryCode,\n\t\t\tscope: queryScope,\n\t\t\tcontext: queryContext\n\t\t};\n\n\t\t// Run request\n\t\tconst request = this.createAPIRequest(REQUEST_BIGCOMMERCE_LOGIN_URL);\n\t\tconst oauthToken = \"/oauth2/token\";\n\n\t\treturn await request.run(\"post\", oauthToken, payload);\n\t}\n\n\t// Handle API requests\n\tasync request(type, path, data = null) {\n\t\t// If current `config` have undefined `accessToken`, throw an error\n\t\tthis.config.accessToken == null ? console.error(FG_RED, \"The access token is required to make BigCommerce API requests.\") : null;\n\n\t\t// If current `config` have undefined `storeHash`, throw an error\n\t\tthis.config.storeHash == null ? console.error(FG_RED, \"The store hash is required to make BigCommerce API requests.\") : null;\n\n\t\t// Prepare `path` for request execution\n\t\tconst extension = this.config.responseType === \"xml\" ? \".xml\" : \"\";\n\t\tconst request = this.createAPIRequest(REQUEST_BIGCOMMERCE_API_URL);\n\t\tconst version = !path.includes(\"v3\") ? path.replace(/(\\?|$)/, extension + \"$1\") : path;\n\n\t\t// Update full path\n\t\tlet fullPath = `/stores/${this.config.storeHash}`;\n\n\t\tfullPath += version;\n\n\t\tconst response = await request.run(type, fullPath, data);\n\n\t\t// If response contains pagination.\n\t\tif (\"meta\" in response && \"pagination\" in response.meta) {\n\t\t\tconst { total_pages: totalPages, current_page: currentPage } = response.meta.pagination;\n\n\t\t\t// If current page is not the last page.\n\t\t\tif (totalPages > currentPage) {\n\t\t\t\t// Collect all page request promises in array.\n\t\t\t\tconst promises = [];\n\n\t\t\t\tfor (let nextPage = currentPage + 1; nextPage <= totalPages; nextPage++) {\n\t\t\t\t\tconst endpointUrl = new URL(fullPath, `https://${request.hostname}`);\n\n\t\t\t\t\t// Safely assign `page` query parameter to endpoint URL.\n\t\t\t\t\tendpointUrl.searchParams.set(\"page\", nextPage);\n\n\t\t\t\t\t// Add promise to array for future Promise.All() call.\n\t\t\t\t\tpromises.push(request.run(type, `${endpointUrl.pathname}${endpointUrl.search}`, data));\n\t\t\t\t}\n\n\t\t\t\t// Request all endpoints in parallel.\n\t\t\t\tconst responses = await Promise.all(promises);\n\n\t\t\t\tresponses.forEach((pageResponse) => {\n\t\t\t\t\tresponse.data = response.data.concat(pageResponse.data);\n\t\t\t\t});\n\n\t\t\t\t// Set pager to last page.\n\t\t\t\tresponse.meta.pagination.total_pages = totalPages;\n\t\t\t\tresponse.meta.pagination.current_page = totalPages;\n\t\t\t}\n\t\t}\n\n\t\t// Run request\n\t\treturn response;\n\t}\n\n\t// Handle `GET` request\n\tasync get(path) {\n\t\treturn await this.request(\"get\", path);\n\t}\n\n\t// Handle `POST` request\n\tasync post(path, data) {\n\t\treturn await this.request(\"post\", path, data);\n\t}\n\n\t// Handle `PUT` request\n\tasync put(path, data) {\n\t\treturn await this.request(\"put\", path, data);\n\t}\n\n\t// Handle `DELETE` request\n\tasync delete(path) {\n\t\treturn await this.request(\"delete\", path);\n\t}\n}\n\nexport default BigCommerce;\n"],"file":"bigcommerce.js"}